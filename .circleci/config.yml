version: 2.1

orbs:
  gusto: gusto/gusto@0.0.13

jobs:
  ruby-test:
    parameters:
      appraisal:
        type: string
    executor: gusto/ruby-2-3
    steps:
      - checkout
      - run:
          name: Configure Bundler
          command: |
            echo 'export BUNDLER_VERSION=$(cat Gemfile.lock | tail -1 | tr -d " ")' >> $BASH_ENV
            source $BASH_ENV
            gem install bundler
      # - restore_cache:
      #     name: Restore Ruby Package Cache
      #     keys:
      #       - v1-dependencies-{{ checksum "<< parameters.gemfile >>.lock" }}
      - run:
          name: Install base dependencies
          command: |
            bundle install --jobs=4 --retry=3 --path vendor/bundle
      - run:
          name: Install appraisal dependencies
          command: |
            bundle exec appraisal << parameters.appraisal >> bundle install --jobs=4 --retry=3 --path vendor/bundle
      # - save_cache:
      #     name: Save Ruby Package Cache
      #     key: v1-dependencies-{{ checksum "<< parameters.gemfile >>.lock" }}
      #     paths:
      #       - ./vendor/bundle
      - run: bundle exec appraisal << parameters.appraisal >> rake
  integration-tests:
    parameters:
      gemfile:
        type: string
    docker:
      - image: circleci/ruby:2.6-node
    steps:
      - gusto/bundle-install:
          gemfile: << parameters.gemfile >>
      - gusto/yarn-install
      - run:
          command: yarn test
          environment:
            GEMFILE: << parameters.gemfile >>
      - run: yarn lint
  release:
    docker:
      - image: circleci/ruby:2.6-node
    steps:
      - gusto/semantic-release-ruby

workflows:
  version: 2
  main:
    jobs:
      - gusto/ruby-lint
      - ruby-test:
          matrix:
            parameters:
              appraisal: ["graphql-1.9", "graphql-1.10"]
      - integration-tests:
          matrix:
            parameters:
              gemfile: ["Gemfile", "graphql-1.9.gemfile"]
      - release:
          filters:
            branches:
              only: master
          requires:
            - gusto/ruby-lint
            - ruby-test
            - integration-tests
